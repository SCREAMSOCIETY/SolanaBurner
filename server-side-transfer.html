<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server-Side cNFT Transfer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #4a65ff;
            margin-bottom: 20px;
        }
        button {
            background-color: #4a65ff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #3a55ee;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .asset-list {
            margin-top: 20px;
        }
        .asset-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .asset-image {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            margin-right: 15px;
            object-fit: cover;
            background-color: #eee;
        }
        .asset-info {
            flex-grow: 1;
        }
        .asset-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .asset-id {
            font-size: 12px;
            color: #888;
            word-break: break-all;
        }
        .asset-actions {
            margin-left: 15px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        #log-container {
            margin-top: 20px;
            background-color: #f0f0f0;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Server-Side cNFT Transfer</h1>
    
    <div class="container">
        <p>This page uses our server-side API to transfer cNFTs without any dependency issues.</p>
        <p>It can transfer compressed NFTs from your wallet to the project wallet: <code>EYjsLzE9VDy3WBd2beeCHA1eVYJxPKVf6NoKKDwq7ujK</code></p>
        
        <button id="connectWalletBtn">Connect Wallet</button>
        <button id="fetchAssetsBtn" disabled>Fetch cNFTs</button>
        
        <div id="walletInfo"></div>
        
        <div id="assetContainer" class="asset-list"></div>
    </div>
    
    <div id="log-container">
        <div class="log-entry info">System ready. Connect your wallet to begin.</div>
    </div>

    <script>
        // Logging functions
        const log = {
            element: document.getElementById('log-container'),
            add: function(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = message;
                this.element.appendChild(entry);
                this.element.scrollTop = this.element.scrollHeight;
            },
            info: function(message) {
                this.add(message, 'info');
            },
            success: function(message) {
                this.add(message, 'success');
            },
            error: function(message) {
                this.add(message, 'error');
            }
        };
        
        // Global variables
        const PROJECT_WALLET = 'EYjsLzE9VDy3WBd2beeCHA1eVYJxPKVf6NoKKDwq7ujK';
        const HELIUS_API_KEY = ''; // We'll use our server-side API
        
        let wallet = null;
        
        // DOM elements
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const fetchAssetsBtn = document.getElementById('fetchAssetsBtn');
        const walletInfo = document.getElementById('walletInfo');
        const assetContainer = document.getElementById('assetContainer');
        
        // Connect wallet
        connectWalletBtn.addEventListener('click', async () => {
            try {
                log.info('Connecting wallet...');
                
                if (!window.solana) {
                    throw new Error('Solana wallet not detected. Please install a Solana wallet extension.');
                }
                
                if (!window.solana.isConnected) {
                    await window.solana.connect();
                }
                
                wallet = {
                    publicKey: window.solana.publicKey.toString(),
                    signTransaction: (tx) => window.solana.signTransaction(tx),
                    signMessage: async (message) => {
                        const encodedMessage = new TextEncoder().encode(message);
                        const signedMessage = await window.solana.signMessage(encodedMessage, 'utf8');
                        return signedMessage.signature;
                    }
                };
                
                log.success(`Wallet connected: ${wallet.publicKey}`);
                walletInfo.textContent = `Connected: ${wallet.publicKey}`;
                
                connectWalletBtn.textContent = 'Wallet Connected';
                fetchAssetsBtn.disabled = false;
            } catch (error) {
                log.error(`Error connecting wallet: ${error.message}`);
            }
        });
        
        // Fetch cNFTs from wallet
        fetchAssetsBtn.addEventListener('click', async () => {
            try {
                if (!wallet) {
                    throw new Error('Wallet not connected');
                }
                
                assetContainer.innerHTML = '<p>Loading cNFTs...</p>';
                log.info('Fetching cNFTs...');
                
                const ownerAddress = wallet.publicKey;
                const url = `/api/helius/wallet-assets/${ownerAddress}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(`API error: ${data.error}`);
                }
                
                const assets = data.data.filter(asset => asset.compression && asset.compression.compressed);
                log.success(`Found ${assets.length} compressed NFTs`);
                
                if (assets.length === 0) {
                    assetContainer.innerHTML = '<p>No compressed NFTs found in this wallet.</p>';
                    return;
                }
                
                renderAssets(assets);
            } catch (error) {
                log.error(`Error fetching assets: ${error.message}`);
                assetContainer.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        });
        
        // Render assets to the container
        function renderAssets(assets) {
            assetContainer.innerHTML = '';
            
            assets.forEach(asset => {
                const card = document.createElement('div');
                card.className = 'asset-card';
                card.setAttribute('data-asset-id', asset.id);
                
                const img = document.createElement('img');
                img.className = 'asset-image';
                img.src = asset.content?.links?.image || asset.content?.files?.[0]?.uri || 'default-nft-image.svg';
                img.alt = asset.content?.metadata?.name || 'NFT Image';
                img.onerror = () => { img.src = 'default-nft-image.svg'; };
                
                const info = document.createElement('div');
                info.className = 'asset-info';
                
                const name = document.createElement('div');
                name.className = 'asset-name';
                name.textContent = asset.content?.metadata?.name || 'Unnamed NFT';
                
                const id = document.createElement('div');
                id.className = 'asset-id';
                id.textContent = asset.id;
                
                const actions = document.createElement('div');
                actions.className = 'asset-actions';
                
                const transferBtn = document.createElement('button');
                transferBtn.textContent = 'Trash';
                transferBtn.onclick = () => transferAsset(asset.id);
                
                info.appendChild(name);
                info.appendChild(id);
                actions.appendChild(transferBtn);
                
                card.appendChild(img);
                card.appendChild(info);
                card.appendChild(actions);
                
                assetContainer.appendChild(card);
            });
        }
        
        // Transfer asset function using server-side API
        async function transferAsset(assetId) {
            try {
                log.info(`Starting transfer for asset: ${assetId}`);
                
                if (!wallet) {
                    throw new Error('Wallet not connected');
                }
                
                // Disable the button and show loading
                const card = document.querySelector(`.asset-card[data-asset-id="${assetId}"]`);
                const transferBtn = card.querySelector('button');
                transferBtn.disabled = true;
                transferBtn.innerHTML = '<span class="loading"></span>';
                
                // 1. Create a message to sign for verification
                const messageToSign = `I authorize the transfer of asset ${assetId} to ${PROJECT_WALLET}. Timestamp: ${Date.now()}`;
                log.info('Signing verification message...');
                
                // 2. Sign the message
                const signedMessage = await wallet.signMessage(messageToSign);
                log.info('Message signed successfully');
                
                // 3. Request a transfer transaction from our server
                log.info('Requesting transfer transaction from server...');
                const generateResponse = await fetch('/api/cnft/generate-transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assetId,
                        walletAddress: wallet.publicKey,
                        signedMessage,
                        messageToSign
                    })
                });
                
                const generateData = await generateResponse.json();
                
                if (!generateData.success) {
                    throw new Error(`Server error: ${generateData.error}`);
                }
                
                log.info('Transfer transaction generated successfully');
                
                // 4. Sign the transaction
                log.info('Signing transaction...');
                const { serializedTransaction } = generateData.data;
                
                // Create a transaction object from the serialized transaction
                const transactionBuffer = Uint8Array.from(atob(serializedTransaction), c => c.charCodeAt(0));
                
                // Sign the transaction
                const signedTransaction = await window.solana.signTransaction(transactionBuffer);
                
                // Serialize the signed transaction
                const serializedSignedTransaction = signedTransaction.serialize ? 
                    signedTransaction.serialize().toString('base64') : 
                    btoa(String.fromCharCode.apply(null, new Uint8Array(signedTransaction)));
                
                // 5. Submit the signed transaction
                log.info('Submitting signed transaction...');
                const submitResponse = await fetch('/api/cnft/submit-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        signedTransaction: serializedSignedTransaction
                    })
                });
                
                const submitData = await submitResponse.json();
                
                if (!submitData.success) {
                    throw new Error(`Transaction error: ${submitData.error}`);
                }
                
                const { signature, explorerUrl } = submitData.data;
                
                log.success(`Transaction sent with signature: ${signature}`);
                log.info(`Explorer URL: ${explorerUrl || `https://solscan.io/tx/${signature}`}`);
                
                // Update UI
                transferBtn.innerHTML = '✓ Sent';
                card.style.opacity = '0.5';
                
                // Hide the card after a delay
                setTimeout(() => {
                    card.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                log.error(`Error transferring asset: ${error.message}`);
                
                // Reset button
                const card = document.querySelector(`.asset-card[data-asset-id="${assetId}"]`);
                if (card) {
                    const transferBtn = card.querySelector('button');
                    transferBtn.disabled = false;
                    transferBtn.textContent = 'Retry';
                }
            }
        }
    </script>
</body>
</html>