<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Solana Token Burner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@0.3.9/lib/index.iife.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav-header">
            <button id="backButton" class="back-button" style="display: none;">
                <span class="back-arrow">‚Üê</span> Back
            </button>
            <h1>Solana Token Burner</h1>
        </div>
        <div class="network-selector">
            <select id="networkSelect" class="network-select">
                <option value="devnet">Devnet</option>
                <option value="mainnet">Mainnet Beta</option>
            </select>
        </div>
        <div class="wallet-section">
            <button class="connect-button" id="connectPhantom">
                <img src="{{ url_for('static', filename='phantom.svg') }}" alt="Phantom" class="wallet-icon">
                Connect Phantom
            </button>
            <div class="connected-status" id="walletStatus" style="display: none">
                <div>Connected to Phantom</div>
                <div class="wallet-address" id="walletAddress"></div>
            </div>
        </div>
        <div id="assetsContainer" class="assets-container" style="display: none">
            <h2>Your Assets</h2>
            <div class="loading-message" id="loadingMessage">Loading your assets...</div>
            <div class="error-message" id="errorMessage" style="display: none"></div>
            <div class="assets-grid" id="assetsGrid" style="display: none">
                <!-- Assets will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const connectPhantomBtn = document.getElementById('connectPhantom');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const assetsContainer = document.getElementById('assetsContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const assetsGrid = document.getElementById('assetsGrid');
            const networkSelect = document.getElementById('networkSelect');
            const backButton = document.getElementById('backButton');

            let currentWallet = null;
            let connection = null;

            // Back button functionality
            backButton.addEventListener('click', () => {
                // Reset view to initial state
                assetsContainer.style.display = 'none';
                walletStatus.style.display = 'none';
                connectPhantomBtn.style.display = 'block';
                backButton.style.display = 'none';

                // Disconnect wallet if connected
                if (currentWallet && currentWallet.disconnect) {
                    try {
                        currentWallet.disconnect();
                    } catch (err) {
                        console.error('Error disconnecting wallet:', err);
                    }
                }
                currentWallet = null;
            });

            function getConnection() {
                const network = networkSelect.value;
                const endpoint = network === 'devnet' 
                    ? 'https://api.devnet.solana.com'
                    : '{{ rpc_endpoint }}';

                console.log(`Connecting to ${endpoint}`);
                return new solanaWeb3.Connection(endpoint, 'confirmed');
            }

            function showError(message) {
                console.error('Error:', message);
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                assetsGrid.style.display = 'none';
            }

            function showLoading() {
                loadingMessage.style.display = 'block';
                errorMessage.style.display = 'none';
                assetsGrid.style.display = 'none';
            }

            async function burnToken(mint, amount, decimals) {
                try {
                    showLoading();
                    errorMessage.style.display = 'none';
                    console.log(`Attempting to burn ${amount} tokens from mint ${mint}`);

                    const response = await fetch('/burn', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            assetType: 'token',
                            assetId: mint,
                            amount: amount,
                            decimals: decimals
                        }),
                    });

                    const data = await response.json();
                    console.log('Burn response:', data);

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to burn token');
                    }

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'status-message success';
                    successMsg.textContent = `Successfully initiated burn of ${amount} tokens`;
                    errorMessage.before(successMsg);
                    setTimeout(() => successMsg.remove(), 5000);

                    // Refresh token list after successful burn
                    await loadAssets(currentWallet.publicKey.toString());
                    return true;
                } catch (error) {
                    console.error('Burn error:', error);
                    showError(`Failed to burn token: ${error.message}`);
                    return false;
                } finally {
                    loadingMessage.style.display = 'none';
                }
            }

            async function loadAssets(publicKey) {
                showLoading();
                try {
                    console.log('Creating connection...');
                    connection = getConnection();

                    console.log('Fetching token accounts...');
                    const response = await fetch(`/assets?wallet=${publicKey}`);
                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch assets');
                    }

                    console.log('Assets data:', data);

                    assetsGrid.innerHTML = '';
                    const tokenSection = document.createElement('div');
                    tokenSection.className = 'asset-section';
                    tokenSection.innerHTML = '<h3>Tokens</h3>';

                    const assets = data.assets;
                    if (!assets.tokens || assets.tokens.length === 0) {
                        assetsGrid.innerHTML = `
                            <div class="no-assets">
                                <p>No tokens found in your wallet</p>
                                <p class="debug-info">Network: ${networkSelect.value}</p>
                                <p class="debug-info">Wallet: ${currentWallet.publicKey.toString()}</p>
                                <p class="debug-info">RPC Status: ${connection ? 'Connected' : 'Not Connected'}</p>
                            </div>
                        `;
                    } else {
                        console.log('Processing tokens:', assets.tokens);
                        assets.tokens.forEach(token => {
                            const tokenCard = document.createElement('div');
                            tokenCard.className = 'asset-card';
                            const displayName = token.name || `Token ${token.mint.slice(0,4)}...${token.mint.slice(-4)}`;
                            const displaySymbol = token.symbol || 'Unknown';

                            tokenCard.innerHTML = `
                                <h4>${displayName}</h4>
                                <p>Symbol: ${displaySymbol}</p>
                                <p>Amount: ${token.amount}</p>
                                <p class="token-address">
                                    <a href="${token.explorer_url}" target="_blank" class="explorer-link">
                                        View on Explorer
                                    </a>
                                </p>
                                ${token.icon ? `<img src="${token.icon}" alt="${displaySymbol}" class="token-icon"/>` : ''}
                                <div class="burn-controls">
                                    <input type="number" 
                                           class="burn-amount" 
                                           placeholder="Amount to burn" 
                                           min="0" 
                                           max="${token.amount}"
                                           step="0.000001"/>
                                    <button class="burn-button" 
                                            data-mint="${token.mint}"
                                            data-decimals="${token.decimals || 9}">
                                        Burn Token
                                    </button>
                                </div>
                            `;

                            // Add burn button event listener
                            const burnButton = tokenCard.querySelector('.burn-button');
                            const burnInput = tokenCard.querySelector('.burn-amount');

                            burnButton.addEventListener('click', async () => {
                                const amount = parseFloat(burnInput.value);
                                if (!amount || amount <= 0 || amount > token.amount) {
                                    showError('Please enter a valid amount to burn');
                                    return;
                                }

                                const success = await burnToken(
                                    burnButton.dataset.mint,
                                    amount,
                                    parseInt(burnButton.dataset.decimals)
                                );

                                if (success) {
                                    tokenCard.classList.add('burned');
                                    setTimeout(() => loadAssets(currentWallet.publicKey.toString()), 1000);
                                }
                            });

                            tokenSection.appendChild(tokenCard);
                        });
                        assetsGrid.appendChild(tokenSection);
                    }

                    loadingMessage.style.display = 'none';
                    errorMessage.style.display = 'none';
                    assetsGrid.style.display = 'block';

                } catch (error) {
                    console.error('Error loading assets:', error);
                    showError(`Failed to load assets: ${error.message}`);
                }
            }

            async function connectPhantom() {
                if (!window.solana || !window.solana.isPhantom) {
                    showError('Please install the Phantom wallet extension');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                try {
                    await window.solana.connect();
                    const publicKey = window.solana.publicKey.toString();
                    currentWallet = window.solana;

                    // Update UI
                    connectPhantomBtn.style.display = 'none';
                    walletStatus.style.display = 'block';
                    walletAddress.textContent = `Address: ${publicKey.slice(0,6)}...${publicKey.slice(-6)}`;
                    assetsContainer.style.display = 'block';
                    backButton.style.display = 'block';

                    // Load assets
                    await loadAssets(publicKey);

                } catch (err) {
                    showError('Failed to connect Phantom wallet. Please try again.');
                    console.error('Phantom connection error:', err);
                }
            }

            // Event Listeners
            connectPhantomBtn.addEventListener('click', connectPhantom);
            networkSelect.addEventListener('change', async () => {
                if (currentWallet && currentWallet.publicKey) {
                    await loadAssets(currentWallet.publicKey.toString());
                }
            });
        });
    </script>
</body>
</html>