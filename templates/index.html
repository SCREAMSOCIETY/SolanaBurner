<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Solana Token Burner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- Only load Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Solana Token Burner</h1>
        <div class="network-selector">
            <select id="networkSelect" class="network-select">
                <option value="devnet">Devnet</option>
                <option value="mainnet">Mainnet Beta</option>
            </select>
        </div>
        <div class="wallet-section">
            <button id="connectButton" class="connect-button">
                <img src="{{ url_for('static', filename='phantom.svg') }}" alt="Phantom" class="wallet-icon">
                Connect Phantom
            </button>
            <div id="walletInfo" class="connected-status" style="display: none;">
                <div>Wallet Connected</div>
                <div id="walletAddress" class="wallet-address"></div>
            </div>
        </div>
        <div id="statusMessage" style="display: none;" class="status-message"></div>

        <div id="assetsContainer" class="assets-container" style="display: none;">
            <h2>Your Assets</h2>
            <div id="loadingMessage" class="loading-message" style="display: none;">Loading assets...</div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="assetsGrid" class="assets-grid"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing wallet handler...");

            const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');

            const connectButton = document.getElementById('connectButton');
            const walletInfo = document.getElementById('walletInfo');
            const walletAddress = document.getElementById('walletAddress');
            const statusMessage = document.getElementById('statusMessage');
            const assetsContainer = document.getElementById('assetsContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const assetsGrid = document.getElementById('assetsGrid');
            const networkSelect = document.getElementById('networkSelect');

            let currentWallet = null;
            let connection = null;

            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                statusMessage.className = `status-message ${isError ? 'error' : 'success'}`;
                console.log(`Status: ${message}`);
            }

            function showLoading(show = true) {
                loadingMessage.style.display = show ? 'block' : 'none';
                if (show) {
                    errorMessage.style.display = 'none';
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                console.error('Error:', message);
            }

            function getConnection() {
                const endpoint = networkSelect.value === 'devnet' 
                    ? 'https://api.devnet.solana.com'
                    : '{{ rpc_endpoint }}';
                return new solanaWeb3.Connection(endpoint, 'confirmed');
            }

            async function burnToken(mint, amount, decimals) {
                showLoading();
                errorMessage.style.display = 'none';

                try {
                    console.log(`Attempting to burn ${amount} tokens from mint ${mint}`);

                    if (!connection) {
                        connection = getConnection();
                    }

                    const mintPubkey = new solanaWeb3.PublicKey(mint);
                    const walletPubkey = currentWallet.publicKey;
                    const rawAmount = Math.floor(amount * Math.pow(10, decimals));

                    // Create the token account address
                    const [tokenAccountPubkey] = await solanaWeb3.PublicKey.findProgramAddress(
                        [
                            walletPubkey.toBuffer(),
                            TOKEN_PROGRAM_ID.toBuffer(),
                            mintPubkey.toBuffer(),
                        ],
                        new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL')
                    );

                    // Create burn instruction data using Uint8Array
                    const dataLayout = new Uint8Array(9);
                    dataLayout[0] = 8; // Burn instruction
                    const amountBytes = new Uint8Array(8);
                    const view = new DataView(amountBytes.buffer);
                    view.setBigUint64(0, BigInt(rawAmount), true);
                    dataLayout.set(amountBytes, 1);

                    // Create the burn instruction
                    const burnIx = new solanaWeb3.TransactionInstruction({
                        keys: [
                            { pubkey: tokenAccountPubkey, isSigner: false, isWritable: true },
                            { pubkey: mintPubkey, isSigner: false, isWritable: true },
                            { pubkey: walletPubkey, isSigner: true, isWritable: false },
                        ],
                        programId: TOKEN_PROGRAM_ID,
                        data: dataLayout
                    });

                    const transaction = new solanaWeb3.Transaction().add(burnIx);
                    transaction.feePayer = walletPubkey;

                    const { blockhash } = await connection.getRecentBlockhash();
                    transaction.recentBlockhash = blockhash;

                    console.log('Sending transaction for signature...');
                    const signed = await currentWallet.signTransaction(transaction);
                    const signature = await connection.sendRawTransaction(signed.serialize());

                    console.log('Transaction sent:', signature);
                    showStatus(`Transaction sent: ${signature}`);

                    const confirmation = await connection.confirmTransaction(signature);

                    if (confirmation.value.err) {
                        throw new Error('Transaction failed to confirm');
                    }

                    showStatus(`Successfully burned ${amount} tokens`);
                    await loadAssets(currentWallet.publicKey.toString());

                    return true;
                } catch (error) {
                    console.error('Burn error:', error);
                    showError(`Failed to burn token: ${error.message}`);
                    return false;
                } finally {
                    showLoading(false);
                }
            }

            async function loadAssets(publicKey) {
                showLoading(true);
                assetsGrid.style.display = 'none';

                try {
                    const response = await fetch(`/assets?wallet=${publicKey}`);
                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch assets');
                    }

                    const assets = data.assets;
                    assetsGrid.innerHTML = '';

                    if (!assets.tokens || assets.tokens.length === 0) {
                        assetsGrid.innerHTML = `
                            <div class="no-assets">
                                <p>No tokens found in your wallet</p>
                            </div>
                        `;
                    } else {
                        assets.tokens.forEach(token => {
                            const tokenCard = document.createElement('div');
                            tokenCard.className = 'asset-card';

                            const displayName = token.name || `Token ${token.mint.slice(0,4)}...${token.mint.slice(-4)}`;

                            tokenCard.innerHTML = `
                                <h4>${displayName}</h4>
                                <p>Symbol: ${token.symbol || 'Unknown'}</p>
                                <p>Amount: ${token.amount}</p>
                                <a href="${token.explorer_url}" target="_blank" class="explorer-link">
                                    View on Explorer
                                </a>
                                <div class="burn-controls">
                                    <input type="number" 
                                           class="burn-amount" 
                                           placeholder="Amount to burn" 
                                           min="0" 
                                           max="${token.amount}"
                                           step="0.000001"/>
                                    <button class="burn-button" 
                                            data-mint="${token.mint}"
                                            data-decimals="${token.decimals || 9}">
                                        Burn Token
                                    </button>
                                </div>
                            `;

                            const burnButton = tokenCard.querySelector('.burn-button');
                            const burnInput = tokenCard.querySelector('.burn-amount');

                            burnButton.addEventListener('click', async () => {
                                const amount = parseFloat(burnInput.value);
                                if (!amount || amount <= 0 || amount > token.amount) {
                                    showError('Please enter a valid amount to burn');
                                    return;
                                }

                                await burnToken(
                                    burnButton.dataset.mint,
                                    amount,
                                    parseInt(burnButton.dataset.decimals)
                                );
                            });

                            assetsGrid.appendChild(tokenCard);
                        });
                    }

                    showLoading(false);
                    assetsGrid.style.display = 'block';

                } catch (error) {
                    console.error('Error loading assets:', error);
                    showError(`Failed to load assets: ${error.message}`);
                }
            }

            async function connectWallet() {
                try {
                    if (!window.solana) {
                        showStatus('Phantom wallet not found. Please install Phantom.', true);
                        window.open('https://phantom.app/', '_blank');
                        return;
                    }

                    if (!window.solana.isPhantom) {
                        showStatus('Please install Phantom wallet', true);
                        return;
                    }

                    showStatus('Connecting to Phantom...');
                    const resp = await window.solana.connect();

                    if (resp.publicKey) {
                        const address = resp.publicKey.toString();
                        console.log('Connected to wallet:', address);
                        currentWallet = window.solana;
                        connection = getConnection();

                        connectButton.style.display = 'none';
                        walletInfo.style.display = 'block';
                        walletAddress.textContent = `Address: ${address.slice(0,6)}...${address.slice(-6)}`;
                        assetsContainer.style.display = 'block';

                        showStatus('Wallet connected successfully');
                        await loadAssets(address);
                    }
                } catch (error) {
                    console.error('Connection error:', error);
                    showStatus(`Failed to connect: ${error.message}`, true);
                }
            }

            connectButton.addEventListener('click', connectWallet);

            networkSelect.addEventListener('change', async () => {
                if (currentWallet && currentWallet.publicKey) {
                    connection = getConnection();
                    await loadAssets(currentWallet.publicKey.toString());
                }
            });

            // Check if wallet is already connected
            if (window.solana && window.solana.isPhantom && window.solana.isConnected) {
                const publicKey = window.solana.publicKey.toString();
                currentWallet = window.solana;
                connection = getConnection();

                connectButton.style.display = 'none';
                walletInfo.style.display = 'block';
                walletAddress.textContent = `Address: ${publicKey.slice(0,6)}...${publicKey.slice(-6)}`;
                assetsContainer.style.display = 'block';

                showStatus('Wallet already connected');
                loadAssets(publicKey);
            }
        });
    </script>
</body>
</html>