<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Solana Token Burner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Solana Token Burner</h1>
        <div class="wallet-section">
            <button id="connectButton" class="connect-button">
                <img src="{{ url_for('static', filename='phantom.svg') }}" alt="Phantom" class="wallet-icon">
                Connect Phantom
            </button>
            <div id="walletInfo" class="connected-status" style="display: none;">
                <div>Wallet Connected</div>
                <div id="walletAddress" class="wallet-address"></div>
            </div>
        </div>
        <div id="statusMessage" style="display: none;" class="status-message"></div>

        <template id="token-card-template">
            <div class="asset-card token-card">
                <div class="token-header">
                    <div class="token-icon-wrapper">
                        <img class="token-icon" src="" alt="Token Icon" />
                    </div>
                    <div class="token-info">
                        <h4 class="token-name"></h4>
                        <span class="token-symbol"></span>
                    </div>
                </div>
                <div class="token-details">
                    <div class="token-balance">
                        <span class="balance-label">Balance:</span>
                        <span class="balance-amount"></span>
                    </div>
                    <div class="token-supply">
                        <span class="supply-label">Supply:</span>
                        <span class="supply-amount"></span>
                    </div>
                    <div class="token-price">
                        <span class="price-label">Price USD:</span>
                        <span class="price-amount"></span>
                    </div>
                    <div class="token-volume">
                        <span class="volume-label">24h Volume:</span>
                        <span class="volume-amount"></span>
                    </div>
                </div>
                <div class="token-actions">
                    <input type="number" class="burn-amount" placeholder="Amount to burn" step="0.000001" />
                    <button class="burn-button">Burn Token</button>
                </div>
            </div>
        </template>

        <template id="nft-card-template">
            <div class="asset-card nft-card">
                <div class="nft-image-wrapper">
                    <img class="nft-image" src="" alt="NFT" />
                </div>
                <div class="nft-info">
                    <h4 class="nft-name"></h4>
                    <p class="nft-collection"></p>
                </div>
            </div>
        </template>

        <template id="cnft-card-template">
            <div class="asset-card cnft-card">
                <div class="cnft-image-wrapper">
                    <img class="cnft-image" src="" alt="cNFT" />
                </div>
                <div class="cnft-info">
                    <h4 class="cnft-name"></h4>
                    <p class="cnft-collection"></p>
                </div>
            </div>
        </template>

        <div id="assetsContainer" class="assets-container" style="display: none;">
            <h2>Your Assets</h2>
            <div class="tabs">
                <button class="tab-button active" data-tab="tokens">Tokens</button>
                <button class="tab-button" data-tab="nfts">NFTs</button>
                <button class="tab-button" data-tab="cnfts">cNFTs</button>
            </div>
            <div id="loadingMessage" class="loading-message" style="display: none;">Loading assets...</div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <div class="tab-content">
                <div id="tokens" class="tab-panel active">
                    <div class="assets-grid"></div>
                </div>
                <div id="nfts" class="tab-panel">
                    <div class="assets-grid"></div>
                </div>
                <div id="cnfts" class="tab-panel">
                    <div class="assets-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing wallet handler...");

            const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');

            const connectButton = document.getElementById('connectButton');
            const walletInfo = document.getElementById('walletInfo');
            const walletAddress = document.getElementById('walletAddress');
            const statusMessage = document.getElementById('statusMessage');
            const assetsContainer = document.getElementById('assetsContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');

            let currentWallet = null;
            let connection = null;

            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                statusMessage.className = `status-message ${isError ? 'error' : 'success'}`;
                console.log(`Status: ${message}`);
            }

            function showLoading(show = true) {
                loadingMessage.style.display = show ? 'block' : 'none';
                if (show) {
                    errorMessage.style.display = 'none';
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                console.error('Error:', message);
            }

            function getConnection() {
                const endpoint = '{{ rpc_endpoint }}';
                console.log('Using RPC endpoint:', endpoint);
                return new solanaWeb3.Connection(endpoint, {
                    commitment: 'confirmed',
                    wsEndpoint: false
                });
            }

            function createTokenCard(token) {
                const template = document.querySelector('#token-card-template');
                const card = template.content.cloneNode(true);

                const iconElem = card.querySelector('.token-icon');
                iconElem.src = token.icon || "{{ url_for('static', filename='default-token-icon.svg') }}";
                iconElem.onerror = function() {
                    this.src = "{{ url_for('static', filename='default-token-icon.svg') }}";
                };

                card.querySelector('.token-name').textContent = token.name || `Token ${token.mint.slice(0,4)}...${token.mint.slice(-4)}`;
                card.querySelector('.token-symbol').textContent = token.symbol || 'Unknown';
                card.querySelector('.balance-amount').textContent = formatNumber(token.amount);
                card.querySelector('.supply-amount').textContent = formatNumber(token.supply);
                card.querySelector('.price-amount').textContent = token.price_usd !== 'Unknown' ? `$${Number(token.price_usd).toFixed(6)}` : 'Unknown';
                card.querySelector('.volume-amount').textContent = token.volume_24h !== 'Unknown' ? `$${formatNumber(token.volume_24h)}` : 'Unknown';


                const burnInput = card.querySelector('.burn-amount');
                burnInput.max = token.amount;
                burnInput.min = 0.000001;

                const burnButton = card.querySelector('.burn-button');
                burnButton.dataset.mint = token.mint;
                burnButton.dataset.decimals = token.decimals;

                burnButton.addEventListener('click', async () => {
                    const amount = parseFloat(burnInput.value);
                    if (!validateBurnAmount(burnInput, token.amount)) {
                        return;
                    }

                    if (!confirm(`Are you sure you want to burn ${amount} ${token.symbol || 'tokens'}? This action cannot be undone.`)) {
                        return;
                    }

                    const result = await burnToken(token.mint, amount, token.decimals);
                    if (result) {
                        burnInput.value = '';
                    }
                });

                return card;
            }

            function createNFTCard(nft) {
                const template = document.querySelector('#nft-card-template');
                const card = template.content.cloneNode(true);

                const imageElem = card.querySelector('.nft-image');
                imageElem.src = nft.image || "{{ url_for('static', filename='default-nft-image.svg') }}";
                imageElem.onerror = function() {
                    this.src = "{{ url_for('static', filename='default-nft-image.svg') }}";
                };

                card.querySelector('.nft-name').textContent = nft.name || 'Unnamed NFT';
                card.querySelector('.nft-collection').textContent = nft.collection || '';

                return card;
            }

            function createCNFTCard(cnft) {
                const template = document.querySelector('#cnft-card-template');
                const card = template.content.cloneNode(true);

                const imageElem = card.querySelector('.cnft-image');
                imageElem.src = cnft.image || "{{ url_for('static', filename='default-nft-image.svg') }}";
                imageElem.onerror = function() {
                    this.src = "{{ url_for('static', filename='default-nft-image.svg') }}";
                };

                card.querySelector('.cnft-name').textContent = cnft.name || 'Unnamed cNFT';
                card.querySelector('.cnft-collection').textContent = cnft.collection || '';

                return card;
            }

            async function loadAssets(publicKey) {
                showLoading(true);
                document.querySelectorAll('.assets-grid').forEach(grid => {
                    grid.innerHTML = '';
                    grid.style.display = 'none';
                });

                try {
                    const response = await fetch(`/assets?wallet=${publicKey}`);
                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch assets');
                    }

                    const assets = data.assets;
                    const assetTypes = {
                        tokens: document.querySelector('#tokens .assets-grid'),
                        nfts: document.querySelector('#nfts .assets-grid'),
                        cnfts: document.querySelector('#cnfts .assets-grid')
                    };

                    if (!assets.tokens || assets.tokens.length === 0) {
                        assetTypes.tokens.innerHTML = '<div class="no-assets">No tokens found</div>';
                    } else {
                        assets.tokens.forEach(token => {
                            const card = createTokenCard(token);
                            assetTypes.tokens.appendChild(card);
                        });
                    }

                    if (!assets.nfts || assets.nfts.length === 0) {
                        assetTypes.nfts.innerHTML = '<div class="no-assets">No NFTs found</div>';
                    } else {
                        assets.nfts.forEach(nft => {
                            const card = createNFTCard(nft);
                            assetTypes.nfts.appendChild(card);
                        });
                    }

                    if (!assets.cnfts || assets.cnfts.length === 0) {
                        assetTypes.cnfts.innerHTML = '<div class="no-assets">No cNFTs found</div>';
                    } else {
                        assets.cnfts.forEach(cnft => {
                            const card = createCNFTCard(cnft);
                            assetTypes.cnfts.appendChild(card);
                        });
                    }

                    showLoading(false);
                    document.querySelectorAll('.assets-grid').forEach(grid => {
                        grid.style.display = 'grid';
                    });

                } catch (error) {
                    console.error('Error loading assets:', error);
                    showError(`Failed to load assets: ${error.message}`);
                }
            }

            async function connectWallet() {
                try {
                    if (!window.solana) {
                        showStatus('Phantom wallet not found. Please install Phantom.', true);
                        window.open('https://phantom.app/', '_blank');
                        return;
                    }

                    if (!window.solana.isPhantom) {
                        showStatus('Please install Phantom wallet', true);
                        return;
                    }

                    showStatus('Connecting to Phantom...');
                    const resp = await window.solana.connect();

                    if (resp.publicKey) {
                        const address = resp.publicKey.toString();
                        console.log('Connected to wallet:', address);
                        currentWallet = window.solana;
                        connection = getConnection();

                        connectButton.style.display = 'none';
                        walletInfo.style.display = 'block';
                        walletAddress.textContent = `Address: ${address.slice(0,6)}...${address.slice(-6)}`;
                        assetsContainer.style.display = 'block';

                        showStatus('Wallet connected successfully');
                        await loadAssets(address);
                    }
                } catch (error) {
                    console.error('Connection error:', error);
                    showStatus(`Failed to connect: ${error.message}`, true);
                }
            }

            connectButton.addEventListener('click', connectWallet);

            // Check if wallet is already connected
            if (window.solana && window.solana.isPhantom && window.solana.isConnected) {
                const publicKey = window.solana.publicKey.toString();
                currentWallet = window.solana;
                connection = getConnection();

                connectButton.style.display = 'none';
                walletInfo.style.display = 'block';
                walletAddress.textContent = `Address: ${publicKey.slice(0,6)}...${publicKey.slice(-6)}`;
                assetsContainer.style.display = 'block';

                showStatus('Wallet already connected');
                loadAssets(publicKey);
            }

            // Tab switching functionality
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            function formatNumber(num) {
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 6
                }).format(num);
            }

            function validateBurnAmount(input, maxAmount) {
                const amount = parseFloat(input.value);
                console.log('Validating burn amount:', amount, 'max:', maxAmount);

                if (isNaN(amount) || amount <= 0) {
                    showError('Please enter a valid amount greater than 0');
                    return false;
                }

                if (amount - maxAmount > Number.EPSILON) {
                    showError(`Amount cannot exceed ${maxAmount}`);
                    return false;
                }

                return true;
            }
            async function burnToken(mint, amount, decimals) {
                showLoading();
                errorMessage.style.display = 'none';

                try {
                    console.log(`Attempting to burn ${amount} tokens from mint ${mint}`);
                    console.log(`Token decimals: ${decimals}`);

                    if (!connection) {
                        connection = getConnection();
                    }

                    const mintPubkey = new solanaWeb3.PublicKey(mint);
                    const walletPubkey = currentWallet.publicKey;

                    console.log(`Burn request details:`);
                    console.log(`- Input amount: ${amount}`);
                    console.log(`- Token decimals: ${decimals}`);

                    const effectiveDecimals = 6; 
                    const multiplier = BigInt(10 ** effectiveDecimals);
                    const rawAmount = BigInt(Math.round(amount * Number(multiplier)));

                    console.log(`- Using effective decimals: ${effectiveDecimals}`);
                    console.log(`- Multiplier: ${multiplier}`);
                    console.log(`- Raw amount to burn: ${rawAmount}`);
                    console.log(`- Final amount in tokens: ${Number(rawAmount) / Number(multiplier)}`);

                    if (rawAmount <= BigInt(0)) {
                        throw new Error('Amount must be greater than 0');
                    }

                    const [tokenAccountPubkey] = await solanaWeb3.PublicKey.findProgramAddress(
                        [
                            walletPubkey.toBuffer(),
                            TOKEN_PROGRAM_ID.toBuffer(),
                            mintPubkey.toBuffer(),
                        ],
                        new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL')
                    );

                    console.log('Creating burn instruction...');
                    const dataLayout = new Uint8Array(9);
                    dataLayout[0] = 8; 
                    const amountBytes = new Uint8Array(8);
                    const view = new DataView(amountBytes.buffer);
                    view.setBigUint64(0, rawAmount, true);
                    dataLayout.set(amountBytes, 1);

                    const burnIx = new solanaWeb3.TransactionInstruction({
                        keys: [
                            { pubkey: tokenAccountPubkey, isSigner: false, isWritable: true },
                            { pubkey: mintPubkey, isSigner: false, isWritable: true },
                            { pubkey: walletPubkey, isSigner: true, isWritable: false },
                        ],
                        programId: TOKEN_PROGRAM_ID,
                        data: dataLayout
                    });

                    const transaction = new solanaWeb3.Transaction().add(burnIx);
                    transaction.feePayer = walletPubkey;

                    console.log('Getting latest blockhash...');
                    const { blockhash } = await connection.getLatestBlockhash('confirmed');
                    transaction.recentBlockhash = blockhash;

                    console.log('Sending transaction for signature...');
                    const signed = await currentWallet.signTransaction(transaction);
                    const signature = await connection.sendRawTransaction(signed.serialize());

                    console.log('Transaction sent:', signature);
                    showStatus(`Transaction sent: ${signature}`);

                    const confirmation = await connection.confirmTransaction(signature);
                    if (confirmation.value.err) {
                        throw new Error('Transaction failed to confirm');
                    }

                    showStatus(`Successfully burned ${amount} tokens`);
                    await loadAssets(currentWallet.publicKey.toString());

                    return true;
                } catch (error) {
                    console.error('Burn error:', error);
                    showError(`Failed to burn token: ${error.message}`);
                    return false;
                } finally {
                    showLoading(false);
                }
            }
        });
    </script>
</body>
</html>