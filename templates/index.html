<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Solana Token Burner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solflare-wallet/sdk@latest/dist/index.iife.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Solana Token Burner</h1>
        <div class="network-badge">
            Network: {{ network|upper }}
        </div>
        <div class="wallet-section">
            <div class="wallet-buttons">
                <button class="connect-button" id="connectPhantom">
                    <img src="{{ url_for('static', filename='phantom.svg') }}" alt="Phantom" class="wallet-icon">
                    Connect Phantom
                </button>
                <button class="connect-button" id="connectSolflare">
                    <img src="{{ url_for('static', filename='solflare.svg') }}" alt="SolFlare" class="wallet-icon">
                    Connect SolFlare
                </button>
            </div>
            <div class="connected-status" id="walletStatus" style="display: none">
                <div>Connected to <span id="walletProvider"></span></div>
                <div class="wallet-address" id="walletAddress"></div>
            </div>
        </div>
        <div class="burn-form" id="burnForm" style="display: none">
            <div class="input-group">
                <label for="assetType">Asset Type:</label>
                <select id="assetType" required>
                    <option value="">Select asset type</option>
                    <option value="token">Tokens</option>
                    <option value="nft">NFTs</option>
                    <option value="vacant">Vacant Accounts</option>
                </select>
            </div>
            <div id="assetSelectContainer" class="input-group" style="display: none">
                <label for="assetSelect">Select Asset:</label>
                <select id="assetSelect" required>
                    <option value="">Select an asset</option>
                </select>
            </div>
            <div id="amountContainer" class="input-group" style="display: none">
                <label for="amount">Amount to Burn:</label>
                <input type="number" id="amount" step="0.000001" min="0">
            </div>
            <button type="submit" id="burnButton">Burn Asset</button>
            <div id="statusMessage" class="status-message" style="display: none"></div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const connectPhantomBtn = document.getElementById('connectPhantom');
            const connectSolflareBtn = document.getElementById('connectSolflare');
            const walletStatus = document.getElementById('walletStatus');
            const walletProvider = document.getElementById('walletProvider');
            const walletAddress = document.getElementById('walletAddress');
            const burnForm = document.getElementById('burnForm');
            const burnButton = document.getElementById('burnButton');
            const statusMessage = document.getElementById('statusMessage');
            const assetType = document.getElementById('assetType');
            const assetSelect = document.getElementById('assetSelect');
            const assetSelectContainer = document.getElementById('assetSelectContainer');
            const amountContainer = document.getElementById('amountContainer');

            let currentWallet = null;
            let currentWalletAddress = null;
            let assets = {};

            async function loadAssets() {
                if (!currentWalletAddress) return;

                try {
                    const response = await fetch(`/assets?wallet=${currentWalletAddress}`);
                    const data = await response.json();
                    if (data.success) {
                        assets = data.assets;
                        updateAssetSelect();
                    } else {
                        showError('Failed to load assets');
                    }
                } catch (error) {
                    console.error('Error loading assets:', error);
                    showError('Failed to load assets');
                }
            }

            function updateAssetSelect() {
                const selectedType = assetType.value;
                assetSelect.innerHTML = '<option value="">Select an asset</option>';

                if (!selectedType) {
                    assetSelectContainer.style.display = 'none';
                    amountContainer.style.display = 'none';
                    return;
                }

                assetSelectContainer.style.display = 'block';
                amountContainer.style.display = selectedType === 'token' ? 'block' : 'none';

                if (selectedType === 'token') {
                    assets.tokens.forEach(token => {
                        const option = document.createElement('option');
                        option.value = token.mint;
                        option.textContent = `${token.name} (${token.symbol})`;
                        assetSelect.appendChild(option);
                    });
                } else if (selectedType === 'nft') {
                    assets.nfts.forEach(nft => {
                        const option = document.createElement('option');
                        option.value = nft.mint;
                        option.textContent = nft.name;
                        assetSelect.appendChild(option);
                    });
                } else if (selectedType === 'vacant') {
                    assets.vacant_accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.address;
                        option.textContent = `${account.address.slice(0,6)}...${account.address.slice(-6)}`;
                        assetSelect.appendChild(option);
                    });
                }
            }

            async function connectPhantom() {
                if (typeof window.solana === 'undefined') {
                    showError('Phantom wallet extension is not installed. Please install it from phantom.app');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                if (!window.solana.isPhantom) {
                    showError('Please install the Phantom wallet extension');
                    return;
                }

                try {
                    await window.solana.connect();
                    const publicKey = window.solana.publicKey.toString();
                    currentWallet = window.solana;
                    currentWalletAddress = publicKey;
                    showConnected('Phantom', publicKey);
                    await loadAssets();
                } catch (err) {
                    console.error('Phantom connection error:', err);
                    showError('Failed to connect Phantom wallet. Please try again.');
                }
            }

            async function connectSolflare() {
                if (typeof window.SolflareWallet === 'undefined') {
                    showError('SolFlare wallet extension is not installed. Please install it from solflare.com');
                    window.open('https://solflare.com/', '_blank');
                    return;
                }

                try {
                    const solflare = new window.SolflareWallet();
                    await solflare.connect();
                    currentWallet = solflare;
                    currentWalletAddress = solflare.publicKey.toString();
                    showConnected('SolFlare', currentWalletAddress);
                    await loadAssets();
                } catch (err) {
                    console.error('SolFlare connection error:', err);
                    showError('Failed to connect SolFlare wallet. Please try again.');
                }
            }

            function showConnected(provider, publicKey) {
                connectPhantomBtn.style.display = 'none';
                connectSolflareBtn.style.display = 'none';
                walletStatus.style.display = 'block';
                burnForm.style.display = 'block';
                walletProvider.textContent = provider;
                walletAddress.textContent = `Address: ${publicKey.slice(0,6)}...${publicKey.slice(-6)}`;
            }

            function showError(message) {
                statusMessage.style.display = 'block';
                statusMessage.textContent = message;
                statusMessage.className = 'status-message error';
            }

            function showSuccess(message) {
                statusMessage.style.display = 'block';
                statusMessage.textContent = message;
                statusMessage.className = 'status-message success';
            }

            connectPhantomBtn.addEventListener('click', connectPhantom);
            connectSolflareBtn.addEventListener('click', connectSolflare);
            assetType.addEventListener('change', updateAssetSelect);

            burnButton.addEventListener('click', async () => {
                const selectedType = assetType.value;
                const selectedAsset = assetSelect.value;
                const amount = document.getElementById('amount').value;

                if (!selectedType || !selectedAsset) {
                    showError('Please select an asset');
                    return;
                }

                if (selectedType === 'token' && (!amount || parseFloat(amount) <= 0)) {
                    showError('Please enter a valid amount');
                    return;
                }

                try {
                    const response = await fetch('/burn', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            assetType: selectedType,
                            assetId: selectedAsset,
                            amount: selectedType === 'token' ? amount : null
                        }),
                    });
                    const data = await response.json();

                    if (data.success) {
                        showSuccess(data.message);
                        assetType.value = '';
                        assetSelect.value = '';
                        if (selectedType === 'token') {
                            document.getElementById('amount').value = '';
                        }
                        updateAssetSelect();
                        await loadAssets();
                    } else {
                        showError(data.message);
                    }
                } catch (err) {
                    console.error('Burn transaction error:', err);
                    showError('Failed to burn asset. Please try again.');
                }
            });
        });
    </script>
</body>
</html>