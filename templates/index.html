<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Solana Token Burner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Solana Token Burner</h1>
        <div class="network-selector">
            <select id="networkSelect" class="network-select">
                <option value="devnet">Devnet</option>
                <option value="mainnet">Mainnet Beta</option>
            </select>
        </div>
        <div class="wallet-section">
            <button id="connectButton" class="connect-button">
                <img src="{{ url_for('static', filename='phantom.svg') }}" alt="Phantom" class="wallet-icon">
                Connect Phantom
            </button>
            <div id="walletInfo" class="connected-status" style="display: none;">
                <div>Wallet Connected</div>
                <div id="walletAddress" class="wallet-address"></div>
            </div>
        </div>
        <div id="statusMessage" style="display: none;" class="status-message"></div>

        <div id="assetsContainer" class="assets-container" style="display: none;">
            <h2>Your Assets</h2>
            <div class="tabs">
                <button class="tab-button active" data-tab="tokens">Tokens</button>
                <button class="tab-button" data-tab="nfts">NFTs</button>
                <button class="tab-button" data-tab="cnfts">cNFTs</button>
            </div>
            <div id="loadingMessage" class="loading-message" style="display: none;">Loading assets...</div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <div class="tab-content">
                <div id="tokens" class="tab-panel active">
                    <div class="assets-grid"></div>
                </div>
                <div id="nfts" class="tab-panel">
                    <div class="assets-grid"></div>
                </div>
                <div id="cnfts" class="tab-panel">
                    <div class="assets-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing wallet handler...");

            const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');

            const connectButton = document.getElementById('connectButton');
            const walletInfo = document.getElementById('walletInfo');
            const walletAddress = document.getElementById('walletAddress');
            const statusMessage = document.getElementById('statusMessage');
            const assetsContainer = document.getElementById('assetsContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const networkSelect = document.getElementById('networkSelect');

            let currentWallet = null;
            let connection = null;

            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                statusMessage.className = `status-message ${isError ? 'error' : 'success'}`;
                console.log(`Status: ${message}`);
            }

            function showLoading(show = true) {
                loadingMessage.style.display = show ? 'block' : 'none';
                if (show) {
                    errorMessage.style.display = 'none';
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                console.error('Error:', message);
            }

            function getConnection() {
                const endpoint = networkSelect.value === 'devnet' 
                    ? 'https://api.devnet.solana.com'
                    : '{{ rpc_endpoint }}';
                console.log('Using RPC endpoint:', endpoint);
                return new solanaWeb3.Connection(endpoint, {
                    commitment: 'confirmed',
                    wsEndpoint: false
                });
            }

            async function burnToken(mint, amount, decimals) {
                showLoading();
                errorMessage.style.display = 'none';

                try {
                    console.log(`Attempting to burn ${amount} tokens from mint ${mint}`);
                    console.log(`Token decimals: ${decimals}`);

                    if (!connection) {
                        connection = getConnection();
                    }

                    const mintPubkey = new solanaWeb3.PublicKey(mint);
                    const walletPubkey = currentWallet.publicKey;

                    // Convert amount to raw value based on decimals
                    console.log(`Burn request details:`);
                    console.log(`- Input amount: ${amount}`);
                    console.log(`- Token decimals: ${decimals}`);

                    // Using BigInt for precise decimal conversion with 6 decimals (standard for most Solana tokens)
                    const effectiveDecimals = 6; // Override to 6 decimals as this is standard for most Solana tokens
                    const multiplier = BigInt(10 ** effectiveDecimals);
                    const rawAmount = BigInt(Math.round(amount * Number(multiplier)));

                    console.log(`- Using effective decimals: ${effectiveDecimals}`);
                    console.log(`- Multiplier: ${multiplier}`);
                    console.log(`- Raw amount to burn: ${rawAmount}`);
                    console.log(`- Final amount in tokens: ${Number(rawAmount) / Number(multiplier)}`);

                    if (rawAmount <= BigInt(0)) {
                        throw new Error('Amount must be greater than 0');
                    }

                    // Get the token account
                    const [tokenAccountPubkey] = await solanaWeb3.PublicKey.findProgramAddress(
                        [
                            walletPubkey.toBuffer(),
                            TOKEN_PROGRAM_ID.toBuffer(),
                            mintPubkey.toBuffer(),
                        ],
                        new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL')
                    );

                    console.log('Creating burn instruction...');
                    const dataLayout = new Uint8Array(9);
                    dataLayout[0] = 8; // Burn instruction
                    const amountBytes = new Uint8Array(8);
                    const view = new DataView(amountBytes.buffer);
                    view.setBigUint64(0, rawAmount, true);
                    dataLayout.set(amountBytes, 1);

                    const burnIx = new solanaWeb3.TransactionInstruction({
                        keys: [
                            { pubkey: tokenAccountPubkey, isSigner: false, isWritable: true },
                            { pubkey: mintPubkey, isSigner: false, isWritable: true },
                            { pubkey: walletPubkey, isSigner: true, isWritable: false },
                        ],
                        programId: TOKEN_PROGRAM_ID,
                        data: dataLayout
                    });

                    const transaction = new solanaWeb3.Transaction().add(burnIx);
                    transaction.feePayer = walletPubkey;

                    console.log('Getting latest blockhash...');
                    const { blockhash } = await connection.getLatestBlockhash('confirmed');
                    transaction.recentBlockhash = blockhash;

                    console.log('Sending transaction for signature...');
                    const signed = await currentWallet.signTransaction(transaction);
                    const signature = await connection.sendRawTransaction(signed.serialize());

                    console.log('Transaction sent:', signature);
                    showStatus(`Transaction sent: ${signature}`);

                    const confirmation = await connection.confirmTransaction(signature);
                    if (confirmation.value.err) {
                        throw new Error('Transaction failed to confirm');
                    }

                    showStatus(`Successfully burned ${amount} tokens`);
                    await loadAssets(currentWallet.publicKey.toString());

                    return true;
                } catch (error) {
                    console.error('Burn error:', error);
                    showError(`Failed to burn token: ${error.message}`);
                    return false;
                } finally {
                    showLoading(false);
                }
            }

            async function loadAssets(publicKey) {
                showLoading(true);
                document.querySelectorAll('.assets-grid').forEach(grid => {
                    grid.style.display = 'none';
                });

                try {
                    const response = await fetch(`/assets?wallet=${publicKey}`);
                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch assets');
                    }

                    const assets = data.assets;
                    const assetTypes = {
                        tokens: document.querySelector('#tokens .assets-grid'),
                        nfts: document.querySelector('#nfts .assets-grid'),
                        cnfts: document.querySelector('#cnfts .assets-grid')
                    };

                    // Clear all grids
                    Object.values(assetTypes).forEach(grid => grid.innerHTML = '');

                    // Handle tokens
                    if (!assets.tokens || assets.tokens.length === 0) {
                        assetTypes.tokens.innerHTML = '<div class="no-assets"><p>No tokens found in your wallet</p></div>';
                    } else {
                        assets.tokens.forEach(token => {
                            const tokenCard = document.createElement('div');
                            tokenCard.className = 'asset-card';

                            const displayName = token.name || `Token ${token.mint.slice(0,4)}...${token.mint.slice(-4)}`;

                            tokenCard.innerHTML = `
                                <h4>${displayName}</h4>
                                <p>Symbol: ${token.symbol || 'Unknown'}</p>
                                <p>Amount: ${token.amount}</p>
                                <a href="${token.explorer_url}" target="_blank" class="explorer-link">
                                    View on Explorer
                                </a>
                                <div class="burn-controls">
                                    <input type="number" 
                                           class="burn-amount" 
                                           placeholder="Amount to burn" 
                                           min="0.000001" 
                                           max="${token.amount}"
                                           step="0.000001"
                                           value=""
                                           style="width: 200px;"/>
                                    <button class="burn-button" 
                                            data-mint="${token.mint}"
                                            data-decimals="${token.decimals || 9}"
                                            data-max="${token.amount}">
                                        Burn Token
                                    </button>
                                </div>
                            `;

                            const burnButton = tokenCard.querySelector('.burn-button');
                            const burnInput = tokenCard.querySelector('.burn-amount');

                            burnButton.addEventListener('click', async () => {
                                const amount = parseFloat(burnInput.value);
                                const maxAmount = parseFloat(burnButton.dataset.max);

                                if (!validateBurnAmount(burnInput, maxAmount)) {
                                    return;
                                }

                                if (!confirm(`Are you sure you want to burn ${amount} tokens? This action cannot be undone.`)) {
                                    return;
                                }

                                const result = await burnToken(
                                    burnButton.dataset.mint,
                                    amount,
                                    parseInt(burnButton.dataset.decimals)
                                );

                                if (result) {
                                    burnInput.value = ''; // Clear input after successful burn
                                }
                            });

                            assetTypes.tokens.appendChild(tokenCard);
                        });
                    }

                    // Handle NFTs
                    if (!assets.nfts || assets.nfts.length === 0) {
                        assetTypes.nfts.innerHTML = '<div class="no-assets"><p>No NFTs found in your wallet</p></div>';
                    } else {
                        assets.nfts.forEach(nft => {
                            const nftCard = document.createElement('div');
                            nftCard.className = 'asset-card nft-card';
                            nftCard.innerHTML = `
                                <h4>${nft.name || 'Unnamed NFT'}</h4>
                                <img src="${nft.image || ''}" alt="${nft.name}" class="nft-image"/>
                                <p>${nft.description || ''}</p>
                                <a href="${nft.explorer_url}" target="_blank" class="explorer-link">
                                    View on Explorer
                                </a>
                            `;
                            assetTypes.nfts.appendChild(nftCard);
                        });
                    }

                    // Handle cNFTs
                    if (!assets.cnfts || assets.cnfts.length === 0) {
                        assetTypes.cnfts.innerHTML = '<div class="no-assets"><p>No cNFTs found in your wallet</p></div>';
                    } else {
                        assets.cnfts.forEach(cnft => {
                            const cnftCard = document.createElement('div');
                            cnftCard.className = 'asset-card cnft-card';
                            cnftCard.innerHTML = `
                                <h4>${cnft.name || 'Unnamed cNFT'}</h4>
                                <img src="${cnft.image || ''}" alt="${cnft.name}" class="nft-image"/>
                                <p>${cnft.description || ''}</p>
                                <a href="${cnft.explorer_url}" target="_blank" class="explorer-link">
                                    View on Explorer
                                </a>
                            `;
                            assetTypes.cnfts.appendChild(cnftCard);
                        });
                    }

                    showLoading(false);
                    document.querySelectorAll('.assets-grid').forEach(grid => {
                        grid.style.display = 'block';
                    });

                } catch (error) {
                    console.error('Error loading assets:', error);
                    showError(`Failed to load assets: ${error.message}`);
                }
            }

            async function connectWallet() {
                try {
                    if (!window.solana) {
                        showStatus('Phantom wallet not found. Please install Phantom.', true);
                        window.open('https://phantom.app/', '_blank');
                        return;
                    }

                    if (!window.solana.isPhantom) {
                        showStatus('Please install Phantom wallet', true);
                        return;
                    }

                    showStatus('Connecting to Phantom...');
                    const resp = await window.solana.connect();

                    if (resp.publicKey) {
                        const address = resp.publicKey.toString();
                        console.log('Connected to wallet:', address);
                        currentWallet = window.solana;
                        connection = getConnection();

                        connectButton.style.display = 'none';
                        walletInfo.style.display = 'block';
                        walletAddress.textContent = `Address: ${address.slice(0,6)}...${address.slice(-6)}`;
                        assetsContainer.style.display = 'block';

                        showStatus('Wallet connected successfully');
                        await loadAssets(address);
                    }
                } catch (error) {
                    console.error('Connection error:', error);
                    showStatus(`Failed to connect: ${error.message}`, true);
                }
            }

            connectButton.addEventListener('click', connectWallet);

            networkSelect.addEventListener('change', async () => {
                if (currentWallet && currentWallet.publicKey) {
                    connection = getConnection();
                    await loadAssets(currentWallet.publicKey.toString());
                }
            });

            // Check if wallet is already connected
            if (window.solana && window.solana.isPhantom && window.solana.isConnected) {
                const publicKey = window.solana.publicKey.toString();
                currentWallet = window.solana;
                connection = getConnection();

                connectButton.style.display = 'none';
                walletInfo.style.display = 'block';
                walletAddress.textContent = `Address: ${publicKey.slice(0,6)}...${publicKey.slice(-6)}`;
                assetsContainer.style.display = 'block';

                showStatus('Wallet already connected');
                loadAssets(publicKey);
            }

            // Tab switching functionality
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and panels
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

                    // Add active class to clicked tab and its panel
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
        });

        function validateBurnAmount(input, maxAmount) {
            const amount = parseFloat(input.value);
            console.log('Validating burn amount:', amount, 'max:', maxAmount);

            if (isNaN(amount) || amount <= 0) {
                showError('Please enter a valid amount greater than 0');
                return false;
            }

            // Use precise comparison for floating point
            if (amount - maxAmount > Number.EPSILON) {
                showError(`Amount cannot exceed ${maxAmount}`);
                return false;
            }

            return true;
        }
    </script>
</body>
</html>