<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Solana Token Burner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solflare-wallet/sdk@latest/dist/index.iife.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Solana Token Burner</h1>
        <div class="wallet-section">
            <div class="wallet-buttons">
                <button class="connect-button" id="connectPhantom">
                    <img src="{{ url_for('static', filename='phantom.svg') }}" alt="Phantom" class="wallet-icon">
                    Connect Phantom
                </button>
                <button class="connect-button" id="connectSolflare">
                    <img src="{{ url_for('static', filename='solflare.svg') }}" alt="SolFlare" class="wallet-icon">
                    Connect SolFlare
                </button>
            </div>
            <div class="connected-status" id="walletStatus" style="display: none">
                <div>Connected to <span id="walletProvider"></span></div>
                <div class="wallet-address" id="walletAddress"></div>
            </div>
        </div>
        <div class="burn-form" id="burnForm" style="display: none">
            <div class="input-group">
                <label for="tokenSelect">Select Token:</label>
                <select id="tokenSelect" required>
                    <option value="">Select a token</option>
                </select>
            </div>
            <div class="input-group">
                <label for="amount">Amount to Burn:</label>
                <input type="number" id="amount" step="0.000001" min="0">
            </div>
            <button type="submit" id="burnButton">Burn Tokens</button>
            <div id="statusMessage" class="status-message" style="display: none"></div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const connectPhantomBtn = document.getElementById('connectPhantom');
            const connectSolflareBtn = document.getElementById('connectSolflare');
            const walletStatus = document.getElementById('walletStatus');
            const walletProvider = document.getElementById('walletProvider');
            const walletAddress = document.getElementById('walletAddress');
            const burnForm = document.getElementById('burnForm');
            const burnButton = document.getElementById('burnButton');
            const statusMessage = document.getElementById('statusMessage');
            const tokenSelect = document.getElementById('tokenSelect');

            let currentWallet = null;

            // Fetch available tokens
            fetch('/tokens')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        data.tokens.forEach(token => {
                            const option = document.createElement('option');
                            option.value = token.mint;
                            option.textContent = `${token.name} (${token.symbol})`;
                            tokenSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching tokens:', error);
                    showError('Failed to load available tokens');
                });

            async function connectPhantom() {
                if (typeof window.solana === 'undefined') {
                    showError('Phantom wallet extension is not installed. Please install it from phantom.app');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                if (!window.solana.isPhantom) {
                    showError('Please install the Phantom wallet extension');
                    return;
                }

                try {
                    await window.solana.connect();
                    const publicKey = window.solana.publicKey.toString();
                    currentWallet = window.solana;
                    showConnected('Phantom', publicKey);
                } catch (err) {
                    console.error('Phantom connection error:', err);
                    showError('Failed to connect Phantom wallet. Please try again.');
                }
            }

            async function connectSolflare() {
                if (typeof window.SolflareWallet === 'undefined') {
                    showError('SolFlare wallet extension is not installed. Please install it from solflare.com');
                    window.open('https://solflare.com/', '_blank');
                    return;
                }

                try {
                    const solflare = new window.SolflareWallet();
                    await solflare.connect();
                    currentWallet = solflare;
                    showConnected('SolFlare', solflare.publicKey.toString());
                } catch (err) {
                    console.error('SolFlare connection error:', err);
                    showError('Failed to connect SolFlare wallet. Please try again.');
                }
            }

            function showConnected(provider, publicKey) {
                connectPhantomBtn.style.display = 'none';
                connectSolflareBtn.style.display = 'none';
                walletStatus.style.display = 'block';
                burnForm.style.display = 'block';
                walletProvider.textContent = provider;
                walletAddress.textContent = `Address: ${publicKey.slice(0,6)}...${publicKey.slice(-6)}`;
            }

            function showError(message) {
                statusMessage.style.display = 'block';
                statusMessage.textContent = message;
                statusMessage.className = 'status-message error';
            }

            function showSuccess(message) {
                statusMessage.style.display = 'block';
                statusMessage.textContent = message;
                statusMessage.className = 'status-message success';
            }

            connectPhantomBtn.addEventListener('click', connectPhantom);
            connectSolflareBtn.addEventListener('click', connectSolflare);

            burnButton.addEventListener('click', async () => {
                const amount = document.getElementById('amount').value;
                const tokenMint = tokenSelect.value;

                if (!tokenMint) {
                    showError('Please select a token');
                    return;
                }

                if (!amount || amount <= 0) {
                    showError('Please enter a valid amount');
                    return;
                }

                try {
                    const response = await fetch('/burn', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ amount, tokenMint }),
                    });
                    const data = await response.json();

                    if (data.success) {
                        showSuccess(data.message);
                        document.getElementById('amount').value = '';
                        tokenSelect.value = '';
                    } else {
                        showError(data.message);
                    }
                } catch (err) {
                    console.error('Burn transaction error:', err);
                    showError('Failed to burn tokens. Please try again.');
                }
            });
        });
    </script>
</body>
</html>