<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Solana Token Burner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@0.3.9/lib/index.iife.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Solana Token Burner</h1>
        <div class="network-selector">
            <select id="networkSelect" class="network-select">
                <option value="devnet">Devnet</option>
                <option value="mainnet">Mainnet Beta</option>
            </select>
        </div>
        <div class="wallet-section">
            <button class="connect-button" id="connectPhantom">
                <img src="{{ url_for('static', filename='phantom.svg') }}" alt="Phantom" class="wallet-icon">
                Connect Phantom
            </button>
            <div class="connected-status" id="walletStatus" style="display: none">
                <div>Connected to Phantom</div>
                <div class="wallet-address" id="walletAddress"></div>
            </div>
        </div>
        <div id="assetsContainer" class="assets-container" style="display: none">
            <h2>Your Assets</h2>
            <div class="loading-message" id="loadingMessage">Loading your assets...</div>
            <div class="error-message" id="errorMessage" style="display: none"></div>
            <div class="assets-grid" id="assetsGrid" style="display: none">
                <!-- Assets will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const connectPhantomBtn = document.getElementById('connectPhantom');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const assetsContainer = document.getElementById('assetsContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const assetsGrid = document.getElementById('assetsGrid');
            const networkSelect = document.getElementById('networkSelect');

            let currentWallet = null;
            let connection = null;

            function getConnection() {
                const network = networkSelect.value;
                const endpoint = network === 'devnet' 
                    ? 'https://api.devnet.solana.com'
                    : '{{ rpc_endpoint }}'; // Use QuickNode RPC URL for mainnet

                console.log(`Connecting to ${endpoint}`);
                return new solanaWeb3.Connection(endpoint, 'confirmed');
            }

            function showError(message) {
                console.error('Error:', message);
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                assetsGrid.style.display = 'none';
            }

            function showLoading() {
                loadingMessage.style.display = 'block';
                errorMessage.style.display = 'none';
                assetsGrid.style.display = 'none';
            }

            async function loadAssets(publicKey) {
                showLoading();
                try {
                    console.log('Creating connection...');
                    connection = getConnection();

                    console.log('Fetching token accounts...');
                    const response = await fetch(`/assets?wallet=${publicKey}`);
                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch assets');
                    }

                    console.log('Assets data:', data);

                    assetsGrid.innerHTML = '';
                    const tokenSection = document.createElement('div');
                    tokenSection.className = 'asset-section';
                    tokenSection.innerHTML = '<h3>Tokens</h3>';

                    const assets = data.assets;
                    if (!assets.tokens || assets.tokens.length === 0) {
                        assetsGrid.innerHTML = '<p class="no-assets">No tokens found in your wallet</p>';
                    } else {
                        assets.tokens.forEach(token => {
                            const tokenCard = document.createElement('div');
                            tokenCard.className = 'asset-card';
                            tokenCard.innerHTML = `
                                <h4>${token.name || 'Unknown Token'}</h4>
                                <p>Symbol: ${token.symbol || 'N/A'}</p>
                                <p>Amount: ${token.amount}</p>
                                ${token.icon ? `<img src="${token.icon}" alt="${token.symbol}" class="token-icon"/>` : ''}
                                <button class="burn-button" data-type="token" data-id="${token.mint}">
                                    Burn Token
                                </button>
                            `;
                            tokenSection.appendChild(tokenCard);
                        });
                        assetsGrid.appendChild(tokenSection);
                    }

                    loadingMessage.style.display = 'none';
                    errorMessage.style.display = 'none';
                    assetsGrid.style.display = 'block';

                } catch (error) {
                    console.error('Error loading assets:', error);
                    showError(`Failed to load assets: ${error.message}`);
                }
            }

            async function connectPhantom() {
                if (!window.solana || !window.solana.isPhantom) {
                    showError('Please install the Phantom wallet extension');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                try {
                    await window.solana.connect();
                    const publicKey = window.solana.publicKey.toString();
                    currentWallet = window.solana;

                    // Update UI
                    connectPhantomBtn.style.display = 'none';
                    walletStatus.style.display = 'block';
                    walletAddress.textContent = `Address: ${publicKey.slice(0,6)}...${publicKey.slice(-6)}`;
                    assetsContainer.style.display = 'block';

                    // Load assets
                    await loadAssets(publicKey);

                } catch (err) {
                    showError('Failed to connect Phantom wallet. Please try again.');
                    console.error('Phantom connection error:', err);
                }
            }

            // Event Listeners
            connectPhantomBtn.addEventListener('click', connectPhantom);
            networkSelect.addEventListener('change', async () => {
                if (currentWallet && currentWallet.publicKey) {
                    await loadAssets(currentWallet.publicKey.toString());
                }
            });

            // Handle burn button clicks
            assetsGrid.addEventListener('click', async (e) => {
                if (e.target.classList.contains('burn-button')) {
                    const type = e.target.dataset.type;
                    const id = e.target.dataset.id;
                    const card = e.target.closest('.asset-card');

                    try {
                        const response = await fetch('/burn', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                assetType: type,
                                assetId: id
                            }),
                        });

                        const data = await response.json();
                        if (data.success) {
                            card.classList.add('burned');
                            setTimeout(() => card.remove(), 1000);
                        } else {
                            throw new Error(data.message);
                        }
                    } catch (error) {
                        showError(`Failed to burn asset: ${error.message}`);
                    }
                }
            });
        });
    </script>
</body>
</html>