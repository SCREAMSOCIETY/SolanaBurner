<!DOCTYPE html>
<html>
<head>
    <title>Standalone cNFT Transfer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        h1 {
            color: #4a65ff;
        }
        button {
            background-color: #4a65ff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #3a55ee;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: #0066cc; }
    </style>
    <!-- CDN imports - load @solana/web3.js directly -->
    <script src="https://unpkg.com/@solana/web3.js@1.50.1/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/bs58@5.0.0/index.js"></script>
</head>
<body>
    <div class="container">
        <h1>Standalone cNFT Transfer</h1>
        <p>This page loads @solana/web3.js directly from CDN instead of using webpack bundled code. This approach should avoid the TransactionInstruction error.</p>
        <p>Target Project Wallet: <code>EYjsLzE9VDy3WBd2beeCHA1eVYJxPKVf6NoKKDwq7ujK</code></p>
        
        <div>
            <button id="connectWalletBtn">Connect Wallet</button>
            <div id="walletStatus">Not connected</div>
        </div>
        
        <div id="assetInputSection" style="margin-top: 20px; display: none;">
            <h3>Enter cNFT Asset ID</h3>
            <input type="text" id="assetIdInput" placeholder="Enter Asset ID (e.g., HWgd4xSyUHgg6Qkp2YaAQXMhgj3nwYP33USzHakREJxQ)">
            <button id="transferBtn">Transfer cNFT</button>
        </div>
        
        <div id="log" class="log">
            <div class="info">Ready to start. Connect your wallet first.</div>
        </div>
    </div>
    
    <script>
        // Constants for the application
        const PROJECT_WALLET = new solanaWeb3.PublicKey('EYjsLzE9VDy3WBd2beeCHA1eVYJxPKVf6NoKKDwq7ujK');
        const BUBBLEGUM_PROGRAM_ID = new solanaWeb3.PublicKey('BGUMAp9Gq7iTEuizy4pqaxsTyUCBK68MDfK752saRPUY');
        const connection = new solanaWeb3.Connection('https://broken-prettiest-needle.solana-mainnet.quiknode.pro/84bb745fca3e8888fc4ac36c2f76d61892c7dda1');
        
        // Log utility functions
        const log = {
            element: document.getElementById('log'),
            add: function(message, type) {
                const entry = document.createElement('div');
                entry.className = type;
                entry.textContent = message;
                this.element.appendChild(entry);
                this.element.scrollTop = this.element.scrollHeight;
            },
            info: function(message) {
                this.add(message, 'info');
            },
            success: function(message) {
                this.add(message, 'success');
            },
            error: function(message) {
                this.add(message, 'error');
            }
        };
        
        // DOM Elements
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletStatus = document.getElementById('walletStatus');
        const assetInputSection = document.getElementById('assetInputSection');
        const assetIdInput = document.getElementById('assetIdInput');
        const transferBtn = document.getElementById('transferBtn');
        
        // Global vars
        let walletPublicKey = null;
        
        // Connect wallet button click handler
        connectWalletBtn.addEventListener('click', async () => {
            try {
                if (!window.solana) {
                    throw new Error('Solana wallet not detected. Please install a compatible wallet extension like Phantom.');
                }
                
                log.info('Connecting to wallet...');
                const resp = await window.solana.connect();
                walletPublicKey = resp.publicKey.toString();
                
                walletStatus.textContent = `Connected: ${walletPublicKey.substring(0, 6)}...${walletPublicKey.substring(walletPublicKey.length - 6)}`;
                connectWalletBtn.textContent = 'Wallet Connected';
                
                log.success(`Successfully connected to wallet: ${walletPublicKey}`);
                assetInputSection.style.display = 'block';
            } catch (err) {
                log.error(`Error connecting to wallet: ${err.message}`);
            }
        });
        
        // Helper function to fetch asset details from server
        async function fetchAssetDetails(assetId) {
            log.info('Fetching asset details...');
            const response = await fetch(`/api/helius/asset/${assetId}`);
            const data = await response.json();
            if (!data.success) {
                throw new Error(`Failed to fetch asset details: ${data.error}`);
            }
            return data.data;
        }
        
        // Helper function to fetch asset proof from server
        async function fetchAssetProof(assetId) {
            log.info('Fetching asset proof...');
            const response = await fetch(`/api/helius/asset-proof/${assetId}`);
            const data = await response.json();
            if (!data.success) {
                throw new Error(`Failed to fetch asset proof: ${data.error}`);
            }
            return data.data;
        }
        
        // Manual creation of transfer instruction to avoid TransactionInstruction issues
        function createTransferInstruction(accounts, programId, data) {
            // Build the instruction object directly
            return {
                programId,
                keys: accounts,
                data
            };
        }
        
        // Helper function for transferring the cNFT
        async function transferCNFT(assetId) {
            log.info(`Starting transfer for asset: ${assetId}`);
            
            if (!walletPublicKey) {
                throw new Error('Wallet not connected');
            }
            
            // Fetch asset details
            const assetData = await fetchAssetDetails(assetId);
            
            // Verify ownership
            if (assetData.ownership.owner !== walletPublicKey) {
                throw new Error(`You don't own this asset. Owner is ${assetData.ownership.owner}`);
            }
            
            // Fetch asset proof
            const proofData = await fetchAssetProof(assetId);
            
            // Extract the tree pubkey from the proof data
            const treeAddress = new solanaWeb3.PublicKey(proofData.tree_id || proofData.tree);
            
            // Derive tree authority PDA
            const [treeAuthority] = solanaWeb3.PublicKey.findProgramAddressSync(
                [treeAddress.toBuffer()],
                BUBBLEGUM_PROGRAM_ID
            );
            
            // Convert proof nodes to PublicKey objects
            const proofNodes = (proofData.proof || []).map(p => new solanaWeb3.PublicKey(p));
            
            // Create data buffer: 8 bytes for anchor instruction discriminator for transfer
            const transferDiscriminator = [101, 185, 186, 2, 163, 45, 146, 64];
            const data = Buffer.from(transferDiscriminator);
            
            // Build account metas for the transfer instruction
            const accountMetas = [
                { pubkey: treeAuthority, isWritable: true, isSigner: false },
                { pubkey: new solanaWeb3.PublicKey(walletPublicKey), isWritable: false, isSigner: true },
                { pubkey: PROJECT_WALLET, isWritable: false, isSigner: false },
                { pubkey: treeAddress, isWritable: true, isSigner: false },
                // Add all proof nodes
                ...proofNodes.map(node => ({
                    pubkey: node,
                    isWritable: false,
                    isSigner: false
                })),
                { pubkey: BUBBLEGUM_PROGRAM_ID, isWritable: false, isSigner: false },
            ];
            
            // Create a new transaction
            const transaction = new solanaWeb3.Transaction();
            
            // Add a system instruction to transfer a tiny amount of SOL to make transaction unique
            transaction.add(
                solanaWeb3.SystemProgram.transfer({
                    fromPubkey: new solanaWeb3.PublicKey(walletPublicKey),
                    toPubkey: PROJECT_WALLET,
                    lamports: 1 // Minimal amount
                })
            );
            
            // Create and add the transfer instruction
            const transferInstruction = createTransferInstruction(accountMetas, BUBBLEGUM_PROGRAM_ID, data);
            transaction.add(transferInstruction);
            
            // Set recent blockhash and fee payer
            transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
            transaction.feePayer = new solanaWeb3.PublicKey(walletPublicKey);
            
            // Sign and send the transaction
            log.info('Signing transaction...');
            const signed = await window.solana.signTransaction(transaction);
            
            log.info('Sending transaction...');
            const txid = await connection.sendRawTransaction(signed.serialize());
            
            log.info('Confirming transaction...');
            const confirmation = await connection.confirmTransaction(txid);
            
            if (confirmation.value.err) {
                throw new Error(`Transaction error: ${JSON.stringify(confirmation.value.err)}`);
            }
            
            return {
                signature: txid,
                status: 'success'
            };
        }
        
        // Transfer cNFT button click handler
        transferBtn.addEventListener('click', async () => {
            const assetId = assetIdInput.value.trim();
            if (!assetId) {
                log.error('Please enter a valid Asset ID');
                return;
            }
            
            transferBtn.disabled = true;
            transferBtn.textContent = 'Processing...';
            
            try {
                const result = await transferCNFT(assetId);
                log.success(`Transaction successful! Signature: ${result.signature}`);
                log.info(`View on explorer: https://solscan.io/tx/${result.signature}`);
                
                transferBtn.textContent = 'Transfer Complete!';
                setTimeout(() => {
                    transferBtn.disabled = false;
                    transferBtn.textContent = 'Transfer cNFT';
                    assetIdInput.value = '';
                }, 3000);
            } catch (err) {
                log.error(`Error transferring asset: ${err.message}`);
                transferBtn.disabled = false;
                transferBtn.textContent = 'Transfer cNFT';
            }
        });
    </script>
</body>
</html>